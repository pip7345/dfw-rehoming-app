<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= pack.name %> - DFW Dog Rehoming</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link href="/tailwind.css" rel="stylesheet" />
  <%- include('partials/analytics-umami') %>
</head>
<body class="bg-bg-primary text-text-primary">
  <script>
    // Define functions early so onclick handlers work
    window.openLightbox = function(index) {
      window._lightboxIndex = index;
      if (window._lightboxReady) window._doOpenLightbox(index);
    };
    window.closeLightbox = function() { if (window._doCloseLightbox) window._doCloseLightbox(); };
    window.prevPhoto = function() { if (window._doPrevPhoto) window._doPrevPhoto(); };
    window.nextPhoto = function() { if (window._doNextPhoto) window._doNextPhoto(); };
    
    function toggleListerSidebar() {
      const content = document.getElementById('lister-sidebar-content');
      const arrow = document.getElementById('lister-sidebar-arrow');
      content.classList.toggle('open');
      arrow.textContent = content.classList.contains('open') ? '‚ñº' : '‚ñ∂';
    }
  </script>
  <%- include('partials/nav-bar', { user }) %>

  <div class="max-w-7xl mx-auto p-6">
    <a href="/" class="text-accent hover:underline inline-flex items-center gap-2 mb-4">‚Üê Back to Home</a>

    <!-- Main Layout: Sidebar + Content on Desktop -->
    <div class="flex flex-col lg:flex-row gap-16">
      <!-- Lister Sidebar (Left on Desktop) -->
      <div class="lg:w-80 flex-shrink-0 lg:order-first">
        <div class="sticky top-6">
          <div class="lister-sidebar-toggle" onclick="toggleListerSidebar()">
            <span>
              About the owner
            </span>
            <span id="lister-sidebar-arrow">‚ñº</span>
          </div>
          
          <div id="lister-sidebar-content" class="lister-sidebar-content open">
              <% if (typeof lister !== 'undefined' && lister && lister.display_name) { %>
                <%= lister.display_name %>
              <% } else { %>
                Contact Lister
              <% } %>

            <% if (typeof lister !== 'undefined' && lister && lister.about) { %>
              <p class="text-text-secondary mb-4 whitespace-pre-line"><%= lister.about %></p>
            <% } %>
            
            <% if (typeof contactPrefs !== 'undefined' && contactPrefs && contactPrefs.show_messenger && contactPrefs.messenger_username) { %>
              <a 
                href="https://m.me/<%= contactPrefs.messenger_username %>" 
                target="_blank"
                class="btn btn-primary mb-3 w-full text-center"
              >
                üí¨ Message on Facebook Messenger
              </a>
            <% } %>
            
            <div class="flex flex-col gap-2">
              <% if (typeof contactPrefs !== 'undefined' && contactPrefs && contactPrefs.show_email && (contactPrefs.email || lister.email)) { %>
                <div class="flex items-center gap-2 text-text-secondary">üìß <a class="text-accent hover:underline" href="mailto:<%= contactPrefs.email || lister.email %>"><%= contactPrefs.email || lister.email %></a></div>
              <% } %>
              <% if (typeof contactPrefs !== 'undefined' && contactPrefs && contactPrefs.show_phone && contactPrefs.phone) { %>
                <div class="flex items-center gap-2 text-text-secondary">üìû <a class="text-accent hover:underline" href="tel:<%= contactPrefs.phone %>"><%= contactPrefs.phone %></a></div>
              <% } %>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="flex-1">
        <!-- Pack Header -->
        <div class="mb-6">
          <h1 class="text-4xl font-bold text-text-primary mb-2 pb-6 border-b border-border"><%= pack.name %></h1>
          <% if (pack.description) { %>
            <p class="text-text-secondary text-lg whitespace-pre-line"><%= pack.description %></p>
          <% } %>
        </div>
        <%
          const pets = pack.pets || [];
          const isSinglePet = pets.length === 1;
        %>
        
        <% if (pets.length > 0) { %>
          <% if (isSinglePet) { %>
            <% const pet = pets[0]; %>
            <div class="mb-6">
              <%- include('partials/single-pet-horizontal', { pet, cloudinaryCloud, cloudinaryPadRgb }) %>
            </div>
          <% } else { %>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
              <% pets.forEach(pet => { %>
                <%- include('partials/pet-details-tile', { pet, cloudinaryCloud, cloudinaryPadRgb, isLister: false, showEditButton: false }) %>
              <% }); %>
            </div>
          <% } %>
        <% } else { %>
          <p class="text-text-secondary">No pets listed in this pack yet.</p>
        <% } %>

    <!-- Photo Gallery Section -->
    <%
      // Collect all photos: pack photos + all pet photos
      const packPhotos = pack.cloudinary_public_ids || [];
      const petPhotos = [];
      if (pack.pets) {
        pack.pets.forEach(pet => {
          if (pet.cloudinary_public_ids && pet.cloudinary_public_ids.length > 0) {
            pet.cloudinary_public_ids.forEach(photoId => {
              petPhotos.push({ id: photoId, petName: pet.name || 'Pet' });
            });
          }
        });
      }
      const allPhotos = [...packPhotos.map(id => ({ id, petName: null })), ...petPhotos];
    %>
    <% if (allPhotos.length > 0) { %>
      <div class="card mb-6">
        <h3 class="text-xl font-semibold text-text-primary mb-4">Photo Gallery</h3>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
          <% allPhotos.forEach((photo, index) => { %>
            <div class="cursor-pointer" onclick="openLightbox(<%= index %>)">
              <img 
                src="https://res.cloudinary.com/<%= cloudinaryCloud %>/image/upload/c_pad,b_rgb:<%= cloudinaryPadRgb %>,w_200,h_150/<%= photo.id %>.jpg" 
                alt="<%= photo.petName ? photo.petName : 'Gallery photo' %>"
                class="w-full aspect-[4/3] object-cover rounded-lg hover:opacity-80 transition-opacity"
              />
            </div>
          <% }); %>
        </div>
      </div>
    <% } %>
      </div>
    </div>
  </div>

  <!-- Lightbox for gallery -->
  <div class="lightbox" id="lightbox">
    <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
    <span class="lightbox-nav lightbox-prev" onclick="prevPhoto()">&#10094;</span>
    <img id="lightbox-img" src="" alt="Gallery photo" />
    <span class="lightbox-nav lightbox-next" onclick="nextPhoto()">&#10095;</span>
  </div>

  <script>
    const CLOUDINARY_CLOUD = '<%= cloudinaryCloud || "" %>';
    <%
      // Rebuild allPhotos for script context
      const scriptPackPhotos = pack.cloudinary_public_ids || [];
      const scriptPetPhotos = [];
      if (pack.pets) {
        pack.pets.forEach(pet => {
          if (pet.cloudinary_public_ids && pet.cloudinary_public_ids.length > 0) {
            pet.cloudinary_public_ids.forEach(photoId => {
              scriptPetPhotos.push(photoId);
            });
          }
        });
      }
      const scriptAllPhotos = [...scriptPackPhotos, ...scriptPetPhotos];
    %>
    const allGalleryPhotos = <%- JSON.stringify(scriptAllPhotos) %>;
    let currentPhotoIndex = 0;

    window._doOpenLightbox = function(index) {
      currentPhotoIndex = index;
      updateLightboxImage();
      document.getElementById('lightbox').classList.add('active');
    };

    window._doCloseLightbox = function() {
      document.getElementById('lightbox').classList.remove('active');
    };

    function updateLightboxImage() {
      const photoId = allGalleryPhotos[currentPhotoIndex];
      document.getElementById('lightbox-img').src = `https://res.cloudinary.com/${CLOUDINARY_CLOUD}/image/upload/${photoId}.jpg`;
    }

    window._doPrevPhoto = function() {
      currentPhotoIndex = (currentPhotoIndex - 1 + allGalleryPhotos.length) % allGalleryPhotos.length;
      updateLightboxImage();
    };

    window._doNextPhoto = function() {
      currentPhotoIndex = (currentPhotoIndex + 1) % allGalleryPhotos.length;
      updateLightboxImage();
    };

    // Re-assign public functions now that implementation is ready
    window.openLightbox = window._doOpenLightbox;
    window.closeLightbox = window._doCloseLightbox;
    window.prevPhoto = window._doPrevPhoto;
    window.nextPhoto = window._doNextPhoto;
    window._lightboxReady = true;

    // If user clicked before ready, open now
    if (typeof window._lightboxIndex !== 'undefined') {
      window._doOpenLightbox(window._lightboxIndex);
    }

    // Close lightbox on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') prevPhoto();
      if (e.key === 'ArrowRight') nextPhoto();
    });

    // Close lightbox when clicking outside image
    document.getElementById('lightbox')?.addEventListener('click', (e) => {
      if (e.target.id === 'lightbox') closeLightbox();
    });

    function openImage(id) {
      const url = `https://res.cloudinary.com/${CLOUDINARY_CLOUD}/image/upload/${id}.jpg`;
      window.open(url, '_blank');
    }
  </script>
  
  <%- include('partials/footer', { user: typeof user !== 'undefined' ? user : undefined }) %>
</body>
</html>