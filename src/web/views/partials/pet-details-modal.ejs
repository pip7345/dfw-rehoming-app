<!-- Pet Details Modal -->
<div class="modal" id="pet-details-modal">
  <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
      <button class="modal-close" onclick="closePetDetailsModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="pet-details-content" id="pet-details-content">
        <!-- Content will be populated dynamically -->
      </div>
    </div>
    <div class="modal-footer" id="pet-details-footer">
      <button type="button" class="btn btn-secondary" onclick="closePetDetailsModal()" style="flex: 1;">Close</button>
    </div>
  </div>
</div>

<script>
  function openPetDetailsModal(petId) {
    fetch(`${API_URL}/pets/${petId}`, {
      credentials: 'include'
    })
    .then(res => res.json())
    .then(data => {
      const pet = data.pet; // Extract pet from API response
      
      // Parse cloudinary_public_ids if it's a string
      const publicIds = typeof pet.cloudinary_public_ids === 'string' 
        ? JSON.parse(pet.cloudinary_public_ids) 
        : pet.cloudinary_public_ids;
      
      const photoUrl = publicIds && publicIds.length > 0
        ? `https://res.cloudinary.com/${CLOUDINARY_CLOUD}/image/upload/c_pad,b_rgb:<%= cloudinaryPadRgb %>,w_800,h_600/${publicIds[0]}.jpg`
        : '';
      
      // Get emoji based on animal type
      const getTypeEmoji = (type) => {
        const emojis = { dog: 'üêï', cat: 'üê±', other: 'üêæ' };
        return emojis[type] || 'üêæ';
      };
      const typeEmoji = getTypeEmoji(pet.animal_type);
      
      // Debug logging for missing photos
      if (!photoUrl) {
        console.log('[Pet Details] Photo not available for pet:', {
          petId: pet.id,
          petName: pet.name,
          cloudinary_public_ids: pet.cloudinary_public_ids,
          parsedPublicIds: publicIds,
          CLOUDINARY_CLOUD: CLOUDINARY_CLOUD
        });
      }
      
      const content = `
        <div class="pet-photo-section">
          ${photoUrl ? `
            <img src="${photoUrl}" alt="${pet.name}" />
          ` : `
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); font-size: 1.5rem;">
              Photo Not Available
            </div>
          `}
        </div>
        
        <div class="pet-info-grid">
          <div class="pet-info-item">
            <span class="pet-info-label">Name</span>
            <span class="pet-info-value">${pet.name || 'N/A'}</span>
          </div>
          
          <div class="pet-info-item">
            <span class="pet-info-label">Rehoming Fee</span>
            <span class="pet-info-value" style="color: var(--success); font-weight: 600; font-size: 1.25rem;">$${pet.rehoming_fee != null ? Number(pet.rehoming_fee).toFixed(0) : '50'}</span>
          </div>
          
          <div class="pet-info-item">
            <span class="pet-info-label">Type</span>
            <span class="pet-info-value">${pet.animal_type ? pet.animal_type.charAt(0).toUpperCase() + pet.animal_type.slice(1) : 'Dog'}</span>
          </div>
          
          <div class="pet-info-item">
            <span class="pet-info-label">Breed</span>
            <span class="pet-info-value">${pet.breed || 'Unknown'}</span>
          </div>
          
          <div class="pet-info-item">
            <span class="pet-info-label">Age</span>
            <span class="pet-info-value">${pet.age ? formatAge(pet.age) : 'Unknown'}</span>
          </div>
          
          <div class="pet-info-item">
            <span class="pet-info-label">Size</span>
            <span class="pet-info-value">${pet.size ? formatSize(pet.size) : 'Unknown'}</span>
          </div>
          
          <div class="pet-info-item">
            <span class="pet-info-label">Status</span>
            <span class="pet-info-value">${pet.status || 'Available'}</span>
          </div>
          
          <div class="pet-info-item">
            <span class="pet-info-label">Listed Date</span>
            <span class="pet-info-value">${pet.listed_date ? new Date(pet.listed_date).toLocaleDateString() : 'N/A'}</span>
          </div>
          
          <div class="pet-info-item">
            <span class="pet-info-label">Expiry Date</span>
            <span class="pet-info-value">${pet.expiry_date ? new Date(pet.expiry_date).toLocaleDateString() : 'N/A'}</span>
          </div>
          
          ${pet.is_hidden ? `
            <div class="pet-info-item">
              <span class="pet-info-label">Visibility</span>
              <span class="pet-info-value">Hidden</span>
            </div>
          ` : ''}
        </div>
        
        ${pet.description ? `
          <div class="pet-description-section">
            <h3>Description</h3>
            <p>${pet.description}</p>
          </div>
        ` : ''}
      `;
      
      document.getElementById('pet-details-content').innerHTML = content;
      
      // Update footer based on whether user is lister
      const isLister = typeof window.isListerView !== 'undefined' && window.isListerView;
      const footer = document.getElementById('pet-details-footer');
      if (isLister) {
        footer.innerHTML = `
          <button type="button" class="btn btn-secondary" onclick="closePetDetailsModal()" style="flex: 1;">Close</button>
          <button type="button" class="btn btn-primary" onclick="editPetFromDetails('${pet.id}', '${pet.pack_id}')" style="flex: 1;">Edit Pet</button>
        `;
      } else {
        if (pet.pack_id) {
          footer.innerHTML = `
            <button type="button" class="btn btn-secondary" onclick="closePetDetailsModal()" style="flex: 1;">Close</button>
            <a href="/pack/${pet.pack_id}" class="btn btn-primary" style="flex: 1; text-decoration: none; display: inline-flex; align-items: center; justify-content: center;">View Pack & Contact Lister</a>
          `;
        } else {
          console.warn('[Pet Details] Pet has no pack_id:', pet);
          footer.innerHTML = `
            <button type="button" class="btn btn-secondary" onclick="closePetDetailsModal()" style="flex: 1;">Close</button>
          `;
        }
      }
      
      document.getElementById('pet-details-modal').classList.add('active');
    })
    .catch(err => {
      console.error(err);
      showToast('‚úó Error loading pet details', 'error');
    });
  }

  function closePetDetailsModal() {
    document.getElementById('pet-details-modal').classList.remove('active');
  }

  function editPetFromDetails(petId, packId) {
    closePetDetailsModal();
    if (typeof window.openPetEditModal === 'function') {
      window.openPetEditModal(petId, packId);
    }
  }

  function formatAge(age) {
    const ageMap = {
      'less_than_8_months': 'Puppy (< 8 months)',
      'eight_to_12_months': '8-12 months',
      'one_to_3_years': '1-3 years',
      'four_to_7_years': '4-7 years',
      'eight_plus_years': '8+ years'
    };
    return ageMap[age] || age;
  }

  function formatSize(size) {
    const sizeMap = {
      'small': 'Small',
      'medium': 'Medium',
      'large': 'Large',
      'extra_large': 'Extra Large'
    };
    return sizeMap[size] || size;
  }

  // Make function globally available
  window.openPetDetailsModal = openPetDetailsModal;
  window.closePetDetailsModal = closePetDetailsModal;
</script>
