<!-- Pet Edit Modal -->
<div class="modal" id="pet-edit-modal">
  <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
      <h2 class="modal-title" id="pet-edit-title">Add Pet</h2>
      <button class="modal-close" onclick="closePetEditModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="pet-edit-form">
        <input type="hidden" name="pet_id" id="edit-pet-id" />
        <input type="hidden" name="pack_id" id="edit-pack-id" />
        <input type="hidden" name="cloudinary_public_ids" id="edit-pet-photos" />
        
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <!-- Photo Upload Section -->
          <div class="photo-upload-section">
            <label style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 500;">Photos</label>
            <button type="button" class="btn btn-secondary" onclick="openEditCloudinaryWidget()" style="margin-bottom: 0.5rem;">ðŸ“· Upload Photos</button>
            <div class="photo-preview-grid" id="edit-photo-preview">
              <span style="color: var(--text-muted); font-size: 0.875rem;">No photos uploaded</span>
            </div>
          </div>

          <!-- Basic Info -->
          <div class="form-row-modal">
            <div class="form-group-modal">
              <label for="edit-pet-name">Pet Name *</label>
              <input type="text" name="name" id="edit-pet-name" required placeholder="e.g., Buddy" />
            </div>

            <div class="form-group-modal">
              <label for="edit-pet-animal-type">Animal Type</label>
              <select name="animal_type" id="edit-pet-animal-type">
                <option value="dog">Dog</option>
                <option value="cat">Cat</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>

          <div class="form-row-modal">
            <div class="form-group-modal">
              <label for="edit-pet-breed">Breed</label>
              <input type="text" name="breed" id="edit-pet-breed" placeholder="e.g., Golden Retriever" />
            </div>

            <div class="form-group-modal">
              <label for="edit-pet-age">Age</label>
              <select name="age" id="edit-pet-age">
                <option value="">Select age...</option>
                <option value="less_than_8_months">Puppy (&lt; 8 months)</option>
                <option value="eight_to_12_months">8-12 months</option>
                <option value="one_to_3_years">1-3 years</option>
                <option value="four_to_7_years">4-7 years</option>
                <option value="eight_plus_years">8+ years</option>
              </select>
            </div>
          </div>

          <div class="form-row-modal">
            <div class="form-group-modal">
              <label for="edit-pet-size">Size</label>
              <select name="size" id="edit-pet-size">
                <option value="">Select size...</option>
                <option value="small">Small (&lt; 25 lbs)</option>
                <option value="medium">Medium (25-60 lbs)</option>
                <option value="large">Large (60-100 lbs)</option>
                <option value="extra_large">Extra Large (100+ lbs)</option>
              </select>
            </div>

            <div class="form-group-modal">
              <label for="edit-pet-gender">Gender</label>
              <select name="gender" id="edit-pet-gender">
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="unspecified">Unspecified</option>
              </select>
            </div>
          </div>

          <div class="form-row-modal">
            <div class="form-group-modal">
              <label for="edit-pet-status">Status</label>
              <select name="status" id="edit-pet-status">
                <option value="available">Available</option>
                <option value="reserved">Reserved</option>
                <option value="sold">Sold</option>
                <option value="hidden">Hidden</option>
              </select>
            </div>

            <div class="form-group-modal">
              <label for="edit-pet-rehoming-fee">Rehoming Fee ($)</label>
              <input type="number" name="rehoming_fee" id="edit-pet-rehoming-fee" min="0" step="0.01" value="50" placeholder="50.00" />
            </div>
          </div>

          <div class="form-row-modal">
            <div class="form-group-modal">
              <label for="edit-pet-expiry">Listing Expiry Date *</label>
              <input type="date" name="expiry_date" id="edit-pet-expiry" required />
            </div>
          </div>

          <div class="form-group-modal">
            <label for="edit-pet-description">Description</label>
            <textarea name="description" id="edit-pet-description" rows="4" placeholder="Tell adopters about this pet's personality, history, needs..."></textarea>
          </div>

          <!-- Receipt Info (if exists) -->
          <div id="edit-receipt-section" style="display: none;">
            <div class="receipt-info">
              <span id="edit-receipt-content"></span>
            </div>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closePetEditModal()">Cancel</button>
      <button type="button" class="btn btn-danger" id="edit-delete-pet-btn" onclick="deletePetFromModal()" style="display: none;">Delete</button>
      <button type="button" class="btn btn-success" onclick="savePetFromModal()" style="flex: 1;">Save Pet</button>
    </div>
  </div>
</div>

<!-- Cloudinary Upload Widget Script -->
<script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>

<script>
  let currentEditPetPhotos = [];

  function openPetEditModal(petId = null, packId = null, petData = null) {
    document.getElementById('edit-pet-id').value = petId || '';
    document.getElementById('edit-pack-id').value = packId || '';
    currentEditPetPhotos = [];

    if (petData) {
      // Edit mode with provided pet data (for temporary pets not yet in database)
      document.getElementById('pet-edit-title').textContent = 'Edit Pet';
      document.getElementById('edit-delete-pet-btn').style.display = 'inline-flex';
      
      document.getElementById('edit-pet-name').value = petData.name || '';
      document.getElementById('edit-pet-animal-type').value = petData.animal_type || 'dog';
      document.getElementById('edit-pet-breed').value = petData.breed || '';
      document.getElementById('edit-pet-age').value = petData.age || '';
      document.getElementById('edit-pet-size').value = petData.size || '';
      document.getElementById('edit-pet-gender').value = petData.gender || 'male';
      document.getElementById('edit-pet-status').value = petData.status || 'available';
      document.getElementById('edit-pet-description').value = petData.description || '';
      document.getElementById('edit-pet-rehoming-fee').value = petData.rehoming_fee ?? 50;
      
      if (petData.expiry_date) {
        document.getElementById('edit-pet-expiry').value = petData.expiry_date;
      }
      
      currentEditPetPhotos = petData.cloudinary_public_ids || [];
      updateEditPhotoPreview();
      
      // Hide receipt section for temporary pets
      document.getElementById('edit-receipt-section').style.display = 'none';
    } else if (petId) {
      // Edit mode - fetch pet data from database
      document.getElementById('pet-edit-title').textContent = 'Edit Pet';
      document.getElementById('edit-delete-pet-btn').style.display = 'inline-flex';
      
      fetch(`${API_URL}/pets/${petId}`, {
        credentials: 'include'
      })
      .then(res => res.json())
      .then(data => {
        const pet = data.pet || data; // Handle both response formats
        document.getElementById('edit-pet-name').value = pet.name || '';
        document.getElementById('edit-pet-animal-type').value = pet.animal_type || 'dog';
        document.getElementById('edit-pet-breed').value = pet.breed || '';
        document.getElementById('edit-pet-age').value = pet.age || '';
        document.getElementById('edit-pet-size').value = pet.size || '';
        document.getElementById('edit-pet-gender').value = pet.gender || 'male';
        document.getElementById('edit-pet-status').value = pet.status || 'available';
        document.getElementById('edit-pet-description').value = pet.description || '';
        document.getElementById('edit-pet-rehoming-fee').value = pet.rehoming_fee ?? 50;
        
        if (pet.expiry_date) {
          document.getElementById('edit-pet-expiry').value = new Date(pet.expiry_date).toISOString().split('T')[0];
        }
        
        // Parse cloudinary_public_ids if it's a JSON string
        if (typeof pet.cloudinary_public_ids === 'string') {
          currentEditPetPhotos = JSON.parse(pet.cloudinary_public_ids);
        } else {
          currentEditPetPhotos = pet.cloudinary_public_ids || [];
        }
        updateEditPhotoPreview();
        
        // Show receipt info if exists
        if (pet.receipt_id) {
          document.getElementById('edit-receipt-section').style.display = 'block';
          document.getElementById('edit-receipt-content').innerHTML = 'ðŸ§¾ <a href="/receipt/' + pet.receipt_id + '" target="_blank">View Receipt</a>';
        } else {
          document.getElementById('edit-receipt-section').style.display = 'block';
          document.getElementById('edit-receipt-content').innerHTML = 'âš ï¸ Not yet paid';
        }
      })
      .catch(err => {
        console.error(err);
        showToast('âœ— Error loading pet', 'error');
      });
    } else {
      // Add mode
      document.getElementById('pet-edit-title').textContent = 'Add Pet';
      document.getElementById('edit-delete-pet-btn').style.display = 'none';
      document.getElementById('edit-receipt-section').style.display = 'none';
      document.getElementById('pet-edit-form').reset();
      
      // Set default expiry date (30 days from now)
      const expiry = new Date();
      expiry.setDate(expiry.getDate() + 30);
      document.getElementById('edit-pet-expiry').value = expiry.toISOString().split('T')[0];
      
      // Set default rehoming fee
      document.getElementById('edit-pet-rehoming-fee').value = 50;
      
      // Set default gender
      document.getElementById('edit-pet-gender').value = 'male';
      
      updateEditPhotoPreview();
    }
    
    document.getElementById('pet-edit-modal').classList.add('active');
  }

  function closePetEditModal() {
    document.getElementById('pet-edit-modal').classList.remove('active');
    currentEditPetPhotos = [];
  }

  function updateEditPhotoPreview() {
    const preview = document.getElementById('edit-photo-preview');
    if (currentEditPetPhotos.length === 0) {
      preview.innerHTML = '<span style="color: var(--text-muted); font-size: 0.875rem;">No photos uploaded</span>';
    } else {
      preview.innerHTML = currentEditPetPhotos.map((id, i) => `
        <div class="photo-preview-item">
          <img src="https://res.cloudinary.com/${CLOUDINARY_CLOUD}/image/upload/c_pad,b_rgb:d1d5db,w_800,h_600/${id}.jpg" />
          <button type="button" class="photo-remove-btn" onclick="removeEditPhoto(${i})">Ã—</button>
        </div>
      `).join('');
    }
    document.getElementById('edit-pet-photos').value = JSON.stringify(currentEditPetPhotos);
  }

  function removeEditPhoto(index) {
    currentEditPetPhotos.splice(index, 1);
    updateEditPhotoPreview();
  }

  function openEditCloudinaryWidget() {
    if (!CLOUDINARY_CLOUD) {
      showToast('âœ— Cloudinary not configured', 'error');
      return;
    }
    
    const widget = cloudinary.createUploadWidget({
      cloudName: CLOUDINARY_CLOUD,
      uploadPreset: CLOUDINARY_PRESET,
      sources: ['local', 'camera', 'google_drive'],
      multiple: true,
      maxFiles: 10,
      resourceType: 'image',
      clientAllowedFormats: ['jpg', 'jpeg', 'png', 'webp'],
      maxFileSize: 10000000, // 10MB max
      cropping: true, // Optional cropping
      showSkipCropButton: true, // Allow users to skip cropping
      croppingShowDimensions: true,
      croppingCoordinatesMode: 'custom',
      folder: 'pets',
      tags: ['pet', 'listing'],
      // Transform image on upload to max height 600 while preserving aspect ratio
      transformation: [
        { height: 600, crop: 'limit', quality: 'auto:good', fetch_format: 'auto' }
      ],
      styles: {
        palette: {
          window: '#1a1d26',
          windowBorder: '#374151',
          tabIcon: '#3b82f6',
          menuIcons: '#9ca3af',
          textDark: '#0f1117',
          textLight: '#f3f4f6',
          link: '#3b82f6',
          action: '#10b981',
          inactiveTabIcon: '#6b7280',
          error: '#ef4444',
          inProgress: '#3b82f6',
          complete: '#10b981',
          sourceBg: '#252830'
        }
      }
    }, (error, result) => {
      if (!result) return;
      
      if (result.event === 'success') {
        currentEditPetPhotos.push(result.info.public_id);
        updateEditPhotoPreview();
        showToast('âœ“ Photo uploaded!', 'success');
      } else if (result.event === 'abort') {
        showToast('Upload cancelled', 'info');
      } else if (error) {
        console.error('Cloudinary upload error:', error);
        showToast('âœ— Upload failed: ' + (error.message || 'Unknown error'), 'error');
      } else if (result.event === 'queues-end' && result.info?.files) {
        // Check for failed uploads
        const failed = result.info.files.filter(f => f.status === 'error');
        if (failed.length > 0) {
          console.error('Failed uploads:', failed);
          showToast(`âœ— ${failed.length} upload(s) failed`, 'error');
        }
      }
    });
    
    widget.open();
  }

  async function savePetFromModal() {
    const form = document.getElementById('pet-edit-form');
    const petId = document.getElementById('edit-pet-id').value;
    const packId = document.getElementById('edit-pack-id').value;
    
    // Validate at least one photo is uploaded
    if (currentEditPetPhotos.length === 0) {
      showToast('âš ï¸ At least one photo is required', 'error');
      return;
    }
    
    const petData = {
      name: document.getElementById('edit-pet-name').value,
      animal_type: document.getElementById('edit-pet-animal-type').value || 'dog',
      breed: document.getElementById('edit-pet-breed').value || null,
      age: document.getElementById('edit-pet-age').value || null,
      size: document.getElementById('edit-pet-size').value || null,
      gender: document.getElementById('edit-pet-gender').value || 'male',
      status: document.getElementById('edit-pet-status').value || 'available',
      description: document.getElementById('edit-pet-description').value || null,
      expiry_date: document.getElementById('edit-pet-expiry').value,
      rehoming_fee: parseFloat(document.getElementById('edit-pet-rehoming-fee').value) || 50,
      cloudinary_public_ids: currentEditPetPhotos
    };
    
    // If packId is 'new', we're on create-pack page - call parent function to save to DB
    if (packId === 'new') {
      if (window.savePetToDatabase) {
        // Extract actual pet ID if editing (will be undefined for new pets)
        const actualPetId = (petId && !petId.startsWith('temp-')) ? petId : null;
        const success = await window.savePetToDatabase(petData, actualPetId);
        if (success) {
          closePetEditModal();
        }
      } else {
        showToast('âœ— Error: Save function not available', 'error');
      }
      return;
    }
    
    if (!packId) {
      showToast('âœ— Pack ID is required', 'error');
      return;
    }
    
    const data = {
      pack_id: packId,
      name: petData.name,
      animal_type: petData.animal_type,
      breed: petData.breed,
      age: petData.age,
      size: petData.size,
      status: petData.status,
      description: petData.description,
      expiry_date: petData.expiry_date,
      rehoming_fee: petData.rehoming_fee,
      cloudinary_public_ids: petData.cloudinary_public_ids
    };
    
    try {
      const url = petId ? `${API_URL}/pets/${petId}` : `${API_URL}/pets`;
      const method = petId ? 'PUT' : 'POST';
      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(data)
      });
      
      if (res.ok) {
        showToast('âœ“ Pet saved successfully!', 'success');
        closePetEditModal();
        setTimeout(() => location.reload(), 1000);
      } else {
        const err = await res.json();
        showToast('âœ— ' + (err.error || 'Failed to save pet'), 'error');
      }
    } catch (err) {
      console.error(err);
      showToast('âœ— Error saving pet', 'error');
    }
  }

  async function deletePetFromModal() {
    const petId = document.getElementById('edit-pet-id').value;
    if (!petId) return;
    
    if (!confirm('Are you sure you want to delete this pet?')) return;
    
    try {
      const res = await fetch(`${API_URL}/pets/${petId}`, {
        method: 'DELETE',
        credentials: 'include'
      });
      
      if (res.ok) {
        showToast('âœ“ Pet deleted', 'success');
        closePetEditModal();
        setTimeout(() => location.reload(), 1000);
      } else {
        const err = await res.json();
        showToast('âœ— ' + (err.error || 'Failed to delete pet'), 'error');
      }
    } catch (err) {
      console.error(err);
      showToast('âœ— Error deleting pet', 'error');
    }
  }

  // Make functions globally available
  window.openPetEditModal = openPetEditModal;
  window.closePetEditModal = closePetEditModal;
</script>
