<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Receipt - DFW Dog Rehoming</title>
  <link href="/tailwind.css" rel="stylesheet" />
  <%- include('partials/analytics-umami') %>
  
</head>
<body class="bg-bg-primary text-text-primary">
  <%- include('partials/nav-bar', { user }) %>
  <div class="max-w-5xl mx-auto p-4 md:p-8">
    <div class="card">
      <div class="flex flex-wrap justify-between gap-4 mb-6">
        <div>
          <h1 class="text-2xl font-semibold">Listing Receipt</h1>
          <span class="inline-block px-2 py-1 rounded-full text-xs font-semibold bg-success/15 text-success"><%= receipt.status %></span>
        </div>
        <div class="text-3xl font-semibold text-success">$<%= Number(receipt.amount).toFixed(2) %></div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 mt-4">
        <div class="bg-bg-tertiary p-3 rounded-lg border border-border">
          <span class="text-[0.65rem] uppercase tracking-wider text-text-muted font-semibold block">Receipt ID</span>
          <span class="mt-1 text-sm text-text-primary break-all"><%= receipt.id %></span>
        </div>
        <div class="meta-block">
          <span class="meta-label">PayPal Order</span>
          <span class="meta-value"><%= receipt.paypal_order_id %></span>
        </div>
        <div class="meta-block">
          <span class="meta-label">User</span>
          <span class="meta-value"><%= receipt.user?.display_name || 'User' %></span>
        </div>
        <div class="meta-block">
          <span class="meta-label">Email</span>
          <span class="meta-value"><%= receipt.user?.email || 'N/A' %></span>
        </div>
        <div class="meta-block">
          <span class="meta-label">Paid At</span>
          <span class="meta-value"><%= new Date(receipt.paid_at).toLocaleString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit'}) %></span>
        </div>
        <div class="meta-block">
          <span class="meta-label">Currency</span>
          <span class="meta-value"><%= receipt.currency %></span>
        </div>
        <div class="meta-block">
          <span class="meta-label">Pets Covered</span>
          <span class="meta-value"><%= petCount %></span>
        </div>
        <div class="meta-block">
          <span class="meta-label">Per-Pet Listing Fee</span>
          <span class="meta-value">$<%= perPet.toFixed(2) %></span>
        </div>
      </div>

      <div class="h-px bg-border my-8"></div>

      <div class="pets-section">
        <h2 class="text-xl font-semibold mb-4">Pets Paid For</h2>
        <% if (petCount === 0) { %>
          <p class="text-text-secondary">No pets associated with this receipt.</p>
        <% } else { %>
          <% Object.keys(packsMap).forEach(packId => { const petsInPack = packsMap[packId]; %>
            <div class="pack-group">
              <div class="text-sm font-semibold text-text-secondary mb-3"><%= packId === 'unassigned' ? 'Unassigned to Pack' : 'Pack ID: ' + packId %> (<%= petsInPack.length %>)</div>
              <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                <% petsInPack.forEach(pet => { %>
                  <div class="bg-bg-tertiary border border-border rounded-xl p-3 flex gap-3 items-start">
                    <div class="w-[72px] h-[72px] rounded-lg bg-bg-hover flex items-center justify-center text-2xl overflow-hidden">
                      <% if (pet.cloudinary_public_ids && pet.cloudinary_public_ids.length > 0) { %>
                        <img src="https://res.cloudinary.com/<%= cloudinaryCloud %>/image/upload/c_pad,b_rgb:<%= cloudinaryPadRgb %>,w_96,h_72/<%= pet.cloudinary_public_ids[0] %>.jpg" alt="<%= pet.name || 'Pet' %>" />
                      <% } else { %>
                        <div class="text-[1.5rem] text-text-muted">No photo</div>
                      <% } %>
                    </div>
                    <div class="flex-1">
                      <h3 class="m-0 text-sm font-semibold"><%= pet.name || 'Unnamed Pet' %></h3>
                      <div class="text-[0.7rem] text-text-muted"><%= pet.breed || 'Mixed Breed' %></div>
                      <%- include('partials/pet-tile-meta', { pet, isLister: true, showBreedTag: false, showStatusTag: true }) %>
                    </div>
                  </div>
                <% }); %>
              </div>
            </div>
          <% }); %>
        <% } %>
      </div>

      <div class="h-px bg-border my-8"></div>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-5">
        <div class="bg-bg-tertiary border border-border rounded-xl p-5">
          <h4 class="m-0 mb-2 text-xs uppercase tracking-wider text-text-muted">Subtotal</h4>
          <div class="text-lg font-semibold">$<%= Number(receipt.amount).toFixed(2) %></div>
        </div>
        <div class="bg-bg-tertiary border border-border rounded-xl p-5">
          <h4 class="m-0 mb-2 text-xs uppercase tracking-wider text-text-muted">Tax</h4>
          <div class="text-lg font-semibold">$0.00</div>
        </div>
        <div class="bg-bg-tertiary border border-border rounded-xl p-5">
          <h4 class="m-0 mb-2 text-xs uppercase tracking-wider text-text-muted">Total Paid</h4>
          <div class="text-lg font-semibold">$<%= Number(receipt.amount).toFixed(2) %></div>
        </div>
      </div>

      <div class="mt-8 flex flex-wrap gap-3">
        <a href="/dashboard" class="btn btn-primary">‚Üê Back to Dashboard</a>
        <a href="/pack/<%= pets[0]?.pack_id || '' %>" class="btn btn-secondary" <% if (!pets[0]?.pack_id) { %>style="pointer-events:none;opacity:.4"<% } %>>View Pack</a>
        <button onclick="window.print()" class="btn btn-secondary">üñ®Ô∏è Print</button>
      </div>
    </div>
  </div>
</body>
</html>
